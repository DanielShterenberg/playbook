rules_version = '2';

// Firestore security rules — implements issues #85 and #76.
//
// Data model:
//   users/{userId}           — user profile (teamId, role cached here)
//   teams/{teamId}           — team document
//                              members map: { [userId]: { role: "admin"|"editor"|"viewer" } }
//   plays/{playId}           — flat play collection (teamId="" for solo users)
//   sharedPlays/{shareToken} — lightweight public share token { playId, createdBy, snapshot }

service cloud.firestore {
  match /databases/{database}/documents {

    // -----------------------------------------------------------------------
    // Helpers
    // -----------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function teamData(teamId) {
      return get(/databases/$(database)/documents/teams/$(teamId)).data;
    }

    function isMember(teamId) {
      return isSignedIn() && teamId != "" && request.auth.uid in teamData(teamId).members;
    }

    function memberRole(teamId) {
      return teamData(teamId).members[request.auth.uid].role;
    }

    function isAdmin(teamId) {
      return isMember(teamId) && memberRole(teamId) == "admin";
    }

    function isEditor(teamId) {
      return isMember(teamId) && (memberRole(teamId) == "admin" || memberRole(teamId) == "editor");
    }

    // -----------------------------------------------------------------------
    // Users
    // -----------------------------------------------------------------------

    match /users/{userId} {
      allow read:   if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
    }

    // -----------------------------------------------------------------------
    // Teams (#74, #75, #76)
    // -----------------------------------------------------------------------

    match /teams/{teamId} {
      // Any team member may read the team document
      allow read: if isMember(teamId);

      // Only the creator can create a new team document
      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;

      // Admins can update team settings; any signed-in user can join via invite code
      allow update: if isSignedIn() && (
        isAdmin(teamId) ||
        // Allow a user to add themselves to the members map (join via invite code)
        request.resource.data.members.keys().hasOnly(resource.data.members.keys().concat([request.auth.uid]))
      );
    }

    // -----------------------------------------------------------------------
    // Plays (#68, #76)
    // -----------------------------------------------------------------------

    match /plays/{playId} {
      // Signed-in owner or team member can read
      allow read: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid ||
        isMember(resource.data.teamId)
      );

      // Authenticated users can create their own plays
      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;

      // Creator or team editor can update
      allow update: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid ||
        isEditor(resource.data.teamId)
      );

      // Creator or team admin can delete
      allow delete: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin(resource.data.teamId)
      );
    }

    // -----------------------------------------------------------------------
    // Invite documents (readable by any signed-in user, #75)
    // Each document: invites/{inviteCode} → { teamId }
    // Allows joinTeamByInviteCode to look up the teamId without querying
    // the protected teams collection.
    // -----------------------------------------------------------------------

    match /invites/{inviteCode} {
      allow read:  if isSignedIn();
      allow write: if isSignedIn();
    }

    // -----------------------------------------------------------------------
    // Shared play tokens (public read-only, #78)
    // -----------------------------------------------------------------------

    match /sharedPlays/{shareToken} {
      // Anyone (even unauthenticated) can read a share token
      allow read: if true;
      // Only authenticated users can create share tokens
      allow create: if isSignedIn();
      // Only the token creator can delete it
      allow delete: if isSignedIn() && resource.data.createdBy == request.auth.uid;
    }
  }
}

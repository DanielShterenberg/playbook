rules_version = '2';

// Firestore security rules — implements issue #85.
//
// Data model:
//   users/{userId}                — user profile
//   teams/{teamId}                — team document (members stored as map)
//   teams/{teamId}/plays/{playId} — play documents
//   sharedPlays/{shareId}         — lightweight read-only share tokens (public)
//
// Team members map shape: { [userId]: { role: "admin" | "editor" | "viewer" } }

service cloud.firestore {
  match /databases/{database}/documents {

    // -----------------------------------------------------------------------
    // Helpers
    // -----------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function teamData(teamId) {
      return get(/databases/$(database)/documents/teams/$(teamId)).data;
    }

    function isMember(teamId) {
      return isSignedIn() && request.auth.uid in teamData(teamId).members;
    }

    function memberRole(teamId) {
      return teamData(teamId).members[request.auth.uid].role;
    }

    function isAdmin(teamId) {
      return isMember(teamId) && memberRole(teamId) == "admin";
    }

    function isEditor(teamId) {
      return isMember(teamId) && (memberRole(teamId) == "admin" || memberRole(teamId) == "editor");
    }

    // -----------------------------------------------------------------------
    // Users
    // -----------------------------------------------------------------------

    match /users/{userId} {
      allow read:   if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      // No delete — soft-delete is handled by the app if needed
    }

    // -----------------------------------------------------------------------
    // Teams
    // -----------------------------------------------------------------------

    match /teams/{teamId} {
      // Any team member may read
      allow read: if isMember(teamId);

      // Only the creator can create a new team document
      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;

      // Only admin can update team settings (name, roster, inviteCode)
      allow update: if isAdmin(teamId);

      // Plays subcollection
      match /plays/{playId} {
        allow read:   if isMember(teamId);
        allow create: if isEditor(teamId);
        allow update: if isEditor(teamId);
        // Only admin or the play's creator may delete
        allow delete: if isAdmin(teamId) || resource.data.createdBy == request.auth.uid;
      }
    }

    // -----------------------------------------------------------------------
    // Shared play tokens (public read, authenticated write)
    // -----------------------------------------------------------------------

    match /sharedPlays/{shareId} {
      // Anyone (even unauthenticated) can read a share token
      allow read: if true;
      // Only authenticated users who own the referenced play can create/delete
      allow create: if isSignedIn();
      allow delete: if isSignedIn() && resource.data.createdBy == request.auth.uid;
    }
  }
}
